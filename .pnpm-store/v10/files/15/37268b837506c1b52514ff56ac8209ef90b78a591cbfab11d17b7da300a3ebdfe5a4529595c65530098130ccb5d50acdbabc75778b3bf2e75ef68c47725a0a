/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{$getNearestNodeOfType as t,removeClassNamesFromElement as e,addClassNamesToElement as r,isHTMLElement as n,mergeRegister as s}from"@lexical/utils";import{$getSelection as i,$isRangeSelection as o,$isRootOrShadowRoot as l,$createParagraphNode as c,$isElementNode as a,$isLeafNode as h,$setPointFromCaret as g,$normalizeCaret as u,$getChildCaret as f,ElementNode as d,$isParagraphNode as p,$applyNodeReplacement as m,$createTextNode as _,createCommand as y,COMMAND_PRIORITY_LOW as T,INSERT_PARAGRAPH_COMMAND as S,$isTextNode as C,TextNode as x}from"lexical";import{getStyleObjectFromCSS as v}from"@lexical/selection";function k(t,...e){const r=new URL("https://lexical.dev/docs/error"),n=new URLSearchParams;n.append("code",t);for(const t of e)n.append("v",t);throw r.search=n.toString(),Error(`Minified Lexical error #${t}; visit ${r.toString()} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)}function b(t){let e=1,r=t.getParent();for(;null!=r;){if(H(r)){const t=r.getParent();if(tt(t)){e++,r=t.getParent();continue}k(40)}return e}return e}function N(t){let e=t.getParent();tt(e)||k(40);let r=e;for(;null!==r;)r=r.getParent(),tt(r)&&(e=r);return e}function F(t){let e=[];const r=t.getChildren().filter(H);for(let t=0;t<r.length;t++){const n=r[t],s=n.getFirstChild();tt(s)?e=e.concat(F(s)):e.push(n)}return e}function P(t){return H(t)&&tt(t.getFirstChild())}function O(t){return q().append(t)}function A(t,e){return H(t)&&(0===e.length||1===e.length&&t.is(e[0])&&0===t.getChildrenSize())}function L(t){const e=i();if(null!==e){let r=e.getNodes();if(o(e)){const n=e.getStartEndPoints();null===n&&k(143);const[s]=n,i=s.getNode(),o=i.getParent();if(l(i)){const t=i.getFirstChild();if(t)r=t.selectStart().getNodes();else{const t=c();i.append(t),r=t.select().getNodes()}}else if(A(i,r)){const e=Z(t);if(l(o)){i.replace(e);const t=q();a(i)&&(t.setFormat(i.getFormatType()),t.setIndent(i.getIndent())),e.append(t)}else if(H(i)){const t=i.getParentOrThrow();E(e,t.getChildren()),t.replace(e)}return}}const n=new Set;for(let e=0;e<r.length;e++){const s=r[e];if(!a(s)||!s.isEmpty()||H(s)||n.has(s.getKey())){if(h(s)){let e=s.getParent();for(;null!=e;){const r=e.getKey();if(tt(e)){if(!n.has(r)){const s=Z(t);E(s,e.getChildren()),e.replace(s),n.add(r)}break}{const s=e.getParent();if(l(s)&&!n.has(r)){n.add(r),M(e,t);break}e=s}}}}else M(s,t)}}}function E(t,e){t.splice(t.getChildrenSize(),0,e)}function M(t,e){if(tt(t))return t;const r=t.getPreviousSibling(),n=t.getNextSibling(),s=q();let i;if(E(s,t.getChildren()),tt(r)&&e===r.getListType())r.append(s),tt(n)&&e===n.getListType()&&(E(r,n.getChildren()),n.remove()),i=r;else if(tt(n)&&e===n.getListType())n.getFirstChildOrThrow().insertBefore(s),i=n;else{const r=Z(e);r.append(s),t.replace(r),i=r}return s.setFormat(t.getFormatType()),s.setIndent(t.getIndent()),t.remove(),i}function w(t,e){const r=t.getLastChild(),n=e.getFirstChild();r&&n&&P(r)&&P(n)&&(w(r.getFirstChild(),n.getFirstChild()),n.remove());const s=e.getChildren();s.length>0&&t.append(...s),e.remove()}function I(){const e=i();if(o(e)){const r=new Set,n=e.getNodes(),s=e.anchor.getNode();if(A(s,n))r.add(N(s));else for(let e=0;e<n.length;e++){const s=n[e];if(h(s)){const e=t(s,K);null!=e&&r.add(N(e))}}for(const t of r){let r=t;const n=F(t);for(const t of n){const n=c().setTextStyle(e.style).setTextFormat(e.format);E(n,t.getChildren()),r.insertAfter(n),r=n,t.__key===e.anchor.key&&g(e.anchor,u(f(n,"next"))),t.__key===e.focus.key&&g(e.focus,u(f(n,"next"))),t.remove()}t.remove()}}}function D(t){const e=new Set;if(P(t)||e.has(t.getKey()))return;const r=t.getParent(),n=t.getNextSibling(),s=t.getPreviousSibling();if(P(n)&&P(s)){const r=s.getFirstChild();if(tt(r)){r.append(t);const s=n.getFirstChild();if(tt(s)){E(r,s.getChildren()),n.remove(),e.add(n.getKey())}}}else if(P(n)){const e=n.getFirstChild();if(tt(e)){const r=e.getFirstChild();null!==r&&r.insertBefore(t)}}else if(P(s)){const e=s.getFirstChild();tt(e)&&e.append(t)}else if(tt(r)){const e=q().setTextFormat(r.getTextFormat()).setTextStyle(r.getTextStyle()),i=Z(r.getListType()).setTextFormat(r.getTextFormat()).setTextStyle(r.getTextStyle());e.append(i),i.append(t),s?s.insertAfter(e):n?n.insertBefore(e):r.append(e)}}function J(t){if(P(t))return;const e=t.getParent(),r=e?e.getParent():void 0;if(tt(r?r.getParent():void 0)&&H(r)&&tt(e)){const n=e?e.getFirstChild():void 0,s=e?e.getLastChild():void 0;if(t.is(n))r.insertBefore(t),e.isEmpty()&&r.remove();else if(t.is(s))r.insertAfter(t),e.isEmpty()&&r.remove();else{const n=e.getListType(),s=q(),i=Z(n);s.append(i),t.getPreviousSiblings().forEach((t=>i.append(t)));const o=q(),l=Z(n);o.append(l),E(l,t.getNextSiblings()),r.insertBefore(s),r.insertAfter(o),r.replace(t)}}}function R(){const t=i();if(!o(t)||!t.isCollapsed())return!1;const e=t.anchor.getNode();if(!H(e)||0!==e.getChildrenSize())return!1;const r=N(e),n=e.getParent();tt(n)||k(40);const s=n.getParent();let a;if(l(s))a=c(),r.insertAfter(a);else{if(!H(s))return!1;a=q(),s.insertAfter(a)}a.setTextStyle(t.style).setTextFormat(t.format).select();const h=e.getNextSiblings();if(h.length>0){const t=Z(n.getListType());if(H(a)){const e=q();e.append(t),a.insertAfter(e)}else a.insertAfter(t);t.append(...h)}return function(t){let e=t;for(;null==e.getNextSibling()&&null==e.getPreviousSibling();){const t=e.getParent();if(null==t||!H(t)&&!tt(t))break;e=t}e.remove()}(e),!0}function W(...t){const e=[];for(const r of t)if(r&&"string"==typeof r)for(const[t]of r.matchAll(/\S+/g))e.push(t);return e}function B(t,e,r){const n=v(e.__textStyle);for(const e in n)t.style.setProperty(`--listitem-marker-${e}`,n[e]);if(r)for(const e in v(r.__textStyle))e in n||t.style.removeProperty(`--listitem-marker-${e}`)}class K extends d{static getType(){return"listitem"}static clone(t){return new K(t.__value,t.__checked,t.__key)}constructor(t,e,r){super(r),this.__value=void 0===t?1:t,this.__checked=e}createDOM(t){const e=document.createElement("li"),r=this.getParent();tt(r)&&"check"===r.getListType()&&U(e,this,null),e.value=this.__value,V(e,t.theme,this);const n=this.__style;return n&&(e.style.cssText=n),B(e,this,null),e}updateDOM(t,e,r){const n=this.getParent();tt(n)&&"check"===n.getListType()&&U(e,this,t),e.value=this.__value,V(e,r.theme,this);const s=t.__style,i=this.__style;return s!==i&&(""===i?e.removeAttribute("style"):e.style.cssText=i),B(e,this,t),!1}static transform(){return t=>{if(H(t)||k(144),null==t.__checked)return;const e=t.getParent();tt(e)&&"check"!==e.getListType()&&null!=t.getChecked()&&t.setChecked(void 0)}}static importDOM(){return{li:()=>({conversion:z,priority:0})}}static importJSON(t){return q().updateFromJSON(t)}updateFromJSON(t){return super.updateFromJSON(t).setValue(t.value).setChecked(t.checked)}exportDOM(t){const e=this.createDOM(t._config);e.style.textAlign=this.getFormatType();const r=this.getDirection();return r&&(e.dir=r),{element:e}}exportJSON(){return{...super.exportJSON(),checked:this.getChecked(),value:this.getValue()}}append(...t){for(let e=0;e<t.length;e++){const r=t[e];if(a(r)&&this.canMergeWith(r)){const t=r.getChildren();this.append(...t),r.remove()}else super.append(r)}return this}replace(t,e){if(H(t))return super.replace(t);this.setIndent(0);const r=this.getParentOrThrow();if(!tt(r))return t;if(r.__first===this.getKey())r.insertBefore(t);else if(r.__last===this.getKey())r.insertAfter(t);else{const e=Z(r.getListType());let n=this.getNextSibling();for(;n;){const t=n;n=n.getNextSibling(),e.append(t)}r.insertAfter(t),t.insertAfter(e)}return e&&(a(t)||k(139),this.getChildren().forEach((e=>{t.append(e)}))),this.remove(),0===r.getChildrenSize()&&r.remove(),t}insertAfter(t,e=!0){const r=this.getParentOrThrow();if(tt(r)||k(39),H(t))return super.insertAfter(t,e);const n=this.getNextSiblings();if(r.insertAfter(t,e),0!==n.length){const s=Z(r.getListType());n.forEach((t=>s.append(t))),t.insertAfter(s,e)}return t}remove(t){const e=this.getPreviousSibling(),r=this.getNextSibling();super.remove(t),e&&r&&P(e)&&P(r)&&(w(e.getFirstChild(),r.getFirstChild()),r.remove())}insertNewAfter(t,e=!0){const r=q().updateFromJSON(this.exportJSON()).setChecked(!this.getChecked()&&void 0);return this.insertAfter(r,e),r}collapseAtStart(t){const e=c();this.getChildren().forEach((t=>e.append(t)));const r=this.getParentOrThrow(),n=r.getParentOrThrow(),s=H(n);if(1===r.getChildrenSize())if(s)r.remove(),n.select();else{r.insertBefore(e),r.remove();const n=t.anchor,s=t.focus,i=e.getKey();"element"===n.type&&n.getNode().is(this)&&n.set(i,n.offset,"element"),"element"===s.type&&s.getNode().is(this)&&s.set(i,s.offset,"element")}else r.insertBefore(e),this.remove();return!0}getValue(){return this.getLatest().__value}setValue(t){const e=this.getWritable();return e.__value=t,e}getChecked(){const t=this.getLatest();let e;const r=this.getParent();return tt(r)&&(e=r.getListType()),"check"===e?Boolean(t.__checked):void 0}setChecked(t){const e=this.getWritable();return e.__checked=t,e}toggleChecked(){const t=this.getWritable();return t.setChecked(!t.__checked)}getIndent(){const t=this.getParent();if(null===t||!this.isAttached())return this.getLatest().__indent;let e=t.getParentOrThrow(),r=0;for(;H(e);)e=e.getParentOrThrow().getParentOrThrow(),r++;return r}setIndent(t){"number"!=typeof t&&k(117),(t=Math.floor(t))>=0||k(199);let e=this.getIndent();for(;e!==t;)e<t?(D(this),e++):(J(this),e--);return this}canInsertAfter(t){return H(t)}canReplaceWith(t){return H(t)}canMergeWith(t){return H(t)||p(t)}extractWithChild(t,e){if(!o(e))return!1;const r=e.anchor.getNode(),n=e.focus.getNode();return this.isParentOf(r)&&this.isParentOf(n)&&this.getTextContent().length===e.getTextContent().length}isParentRequired(){return!0}createParentElementNode(){return Z("bullet")}canMergeWhenEmpty(){return!0}}function V(t,n,s){const i=[],o=[],l=n.list,c=l?l.listitem:void 0;let a;if(l&&l.nested&&(a=l.nested.listitem),void 0!==c&&i.push(...W(c)),l){const t=s.getParent(),e=tt(t)&&"check"===t.getListType(),r=s.getChecked();e&&!r||o.push(l.listitemUnchecked),e&&r||o.push(l.listitemChecked),e&&i.push(r?l.listitemChecked:l.listitemUnchecked)}if(void 0!==a){const t=W(a);s.getChildren().some((t=>tt(t)))?i.push(...t):o.push(...t)}o.length>0&&e(t,...o),i.length>0&&r(t,...i)}function U(t,e,r,n){tt(e.getFirstChild())?(t.removeAttribute("role"),t.removeAttribute("tabIndex"),t.removeAttribute("aria-checked")):(t.setAttribute("role","checkbox"),t.setAttribute("tabIndex","-1"),r&&e.__checked===r.__checked||t.setAttribute("aria-checked",e.getChecked()?"true":"false"))}function z(t){if(t.classList.contains("task-list-item"))for(const e of t.children)if("INPUT"===e.tagName)return $(e);const e=t.getAttribute("aria-checked");return{node:q("true"===e||"false"!==e&&void 0)}}function $(t){if(!("checkbox"===t.getAttribute("type")))return{node:null};return{node:q(t.hasAttribute("checked"))}}function q(t){return m(new K(void 0,t))}function H(t){return t instanceof K}class j extends d{static getType(){return"list"}static clone(t){const e=t.__listType||Y[t.__tag];return new j(e,t.__start,t.__key)}constructor(t="number",e=1,r){super(r);const n=Y[t]||t;this.__listType=n,this.__tag="number"===n?"ol":"ul",this.__start=e}getTag(){return this.__tag}setListType(t){const e=this.getWritable();return e.__listType=t,e.__tag="number"===t?"ol":"ul",e}getListType(){return this.__listType}getStart(){return this.__start}setStart(t){const e=this.getWritable();return e.__start=t,e}createDOM(t,e){const r=this.__tag,n=document.createElement(r);return 1!==this.__start&&n.setAttribute("start",String(this.__start)),n.__lexicalListType=this.__listType,G(n,t.theme,this),n}updateDOM(t,e,r){return t.__tag!==this.__tag||(G(e,r.theme,this),!1)}static transform(){return t=>{tt(t)||k(163),function(t){const e=t.getNextSibling();tt(e)&&t.getListType()===e.getListType()&&w(t,e)}(t),function(t){const e="check"!==t.getListType();let r=t.getStart();for(const n of t.getChildren())H(n)&&(n.getValue()!==r&&n.setValue(r),e&&null!=n.getLatest().__checked&&n.setChecked(void 0),tt(n.getFirstChild())||r++)}(t)}}static importDOM(){return{ol:()=>({conversion:X,priority:0}),ul:()=>({conversion:X,priority:0})}}static importJSON(t){return Z().updateFromJSON(t)}updateFromJSON(t){return super.updateFromJSON(t).setListType(t.listType).setStart(t.start)}exportDOM(t){const e=this.createDOM(t._config,t);return n(e)&&(1!==this.__start&&e.setAttribute("start",String(this.__start)),"check"===this.__listType&&e.setAttribute("__lexicalListType","check")),{element:e}}exportJSON(){return{...super.exportJSON(),listType:this.getListType(),start:this.getStart(),tag:this.getTag()}}canBeEmpty(){return!1}canIndent(){return!1}splice(t,e,r){let n=r;for(let t=0;t<r.length;t++){const e=r[t];H(e)||(n===r&&(n=[...r]),n[t]=q().append(!a(e)||tt(e)||e.isInline()?e:_(e.getTextContent())))}return super.splice(t,e,n)}extractWithChild(t){return H(t)}}function G(t,n,s){const i=[],o=[],l=n.list;if(void 0!==l){const t=l[`${s.__tag}Depth`]||[],e=b(s)-1,r=e%t.length,n=t[r],c=l[s.__tag];let a;const h=l.nested,g=l.checklist;if(void 0!==h&&h.list&&(a=h.list),void 0!==c&&i.push(c),void 0!==g&&"check"===s.__listType&&i.push(g),void 0!==n){i.push(...W(n));for(let e=0;e<t.length;e++)e!==r&&o.push(s.__tag+e)}if(void 0!==a){const t=W(a);e>1?i.push(...t):o.push(...t)}}o.length>0&&e(t,...o),i.length>0&&r(t,...i)}function Q(t){const e=[];for(let r=0;r<t.length;r++){const n=t[r];if(H(n)){e.push(n);const t=n.getChildren();t.length>1&&t.forEach((t=>{tt(t)&&e.push(O(t))}))}else e.push(O(n))}return e}function X(t){const e=t.nodeName.toLowerCase();let r=null;if("ol"===e){r=Z("number",t.start)}else"ul"===e&&(r=function(t){if("check"===t.getAttribute("__lexicallisttype")||t.classList.contains("contains-task-list"))return!0;for(const e of t.childNodes)if(n(e)&&e.hasAttribute("aria-checked"))return!0;return!1}(t)?Z("check"):Z("bullet"));return{after:Q,node:r}}const Y={ol:"number",ul:"bullet"};function Z(t="number",e=1){return m(new j(t,e))}function tt(t){return t instanceof j}const et=y("INSERT_UNORDERED_LIST_COMMAND"),rt=y("INSERT_ORDERED_LIST_COMMAND"),nt=y("INSERT_CHECK_LIST_COMMAND"),st=y("REMOVE_LIST_COMMAND");function it(t){return s(t.registerCommand(rt,(()=>(L("number"),!0)),T),t.registerCommand(et,(()=>(L("bullet"),!0)),T),t.registerCommand(st,(()=>(I(),!0)),T),t.registerCommand(S,(()=>R()),T),t.registerNodeTransform(K,(t=>{const e=t.getFirstChild();if(e){if(C(e)){const r=e.getStyle(),n=e.getFormat();t.getTextStyle()!==r&&t.setTextStyle(r),t.getTextFormat()!==n&&t.setTextFormat(n)}}else{const e=i();o(e)&&(e.style!==t.getTextStyle()||e.format!==t.getTextFormat())&&e.isCollapsed()&&t.is(e.anchor.getNode())&&t.setTextStyle(e.style).setTextFormat(e.format)}})),t.registerNodeTransform(x,(t=>{const e=t.getParent();if(H(e)&&t.is(e.getFirstChild())){const r=t.getStyle(),n=t.getFormat();r===e.getTextStyle()&&n===e.getTextFormat()||e.setTextStyle(r).setTextFormat(n)}})))}function ot(t,e){t.update((()=>L(e)))}function lt(t){t.update((()=>I()))}export{q as $createListItemNode,Z as $createListNode,b as $getListDepth,R as $handleListInsertParagraph,L as $insertList,H as $isListItemNode,tt as $isListNode,I as $removeList,nt as INSERT_CHECK_LIST_COMMAND,rt as INSERT_ORDERED_LIST_COMMAND,et as INSERT_UNORDERED_LIST_COMMAND,K as ListItemNode,j as ListNode,st as REMOVE_LIST_COMMAND,ot as insertList,it as registerList,lt as removeList};
