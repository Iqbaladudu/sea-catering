{"version":3,"sources":["../src/updateOne.ts"],"sourcesContent":["import type { LibSQLDatabase } from 'drizzle-orm/libsql'\nimport type { UpdateOne } from 'payload'\n\nimport toSnakeCase from 'to-snake-case'\n\nimport type { DrizzleAdapter } from './types.js'\n\nimport { buildQuery } from './queries/buildQuery.js'\nimport { selectDistinct } from './queries/selectDistinct.js'\nimport { upsertRow } from './upsertRow/index.js'\nimport { getTransaction } from './utilities/getTransaction.js'\n\nexport const updateOne: UpdateOne = async function updateOne(\n  this: DrizzleAdapter,\n  {\n    id,\n    collection: collectionSlug,\n    data,\n    joins: joinQuery,\n    locale,\n    req,\n    returning,\n    select,\n    where: whereArg,\n  },\n) {\n  const db = await getTransaction(this, req)\n  const collection = this.payload.collections[collectionSlug].config\n  const tableName = this.tableNameMap.get(toSnakeCase(collection.slug))\n  let idToUpdate = id\n\n  if (!idToUpdate) {\n    const { joins, selectFields, where } = buildQuery({\n      adapter: this,\n      fields: collection.flattenedFields,\n      locale,\n      tableName,\n      where: whereArg,\n    })\n\n    // selectDistinct will only return if there are joins\n    const selectDistinctResult = await selectDistinct({\n      adapter: this,\n      db,\n      joins,\n      query: ({ query }) => query.limit(1),\n      selectFields,\n      tableName,\n      where,\n    })\n\n    if (selectDistinctResult?.[0]?.id) {\n      idToUpdate = selectDistinctResult?.[0]?.id\n      // If id wasn't passed but `where` without any joins, retrieve it with findFirst\n    } else if (whereArg && !joins.length) {\n      const table = this.tables[tableName]\n\n      const docsToUpdate = await (db as LibSQLDatabase)\n        .select({\n          id: table.id,\n        })\n        .from(table)\n        .where(where)\n        .limit(1)\n      idToUpdate = docsToUpdate?.[0]?.id\n    }\n  }\n\n  const result = await upsertRow({\n    id: idToUpdate,\n    adapter: this,\n    data,\n    db,\n    fields: collection.flattenedFields,\n    ignoreResult: returning === false,\n    joinQuery,\n    operation: 'update',\n    req,\n    select,\n    tableName,\n  })\n\n  if (returning === false) {\n    return null\n  }\n\n  return result\n}\n"],"names":["toSnakeCase","buildQuery","selectDistinct","upsertRow","getTransaction","updateOne","id","collection","collectionSlug","data","joins","joinQuery","locale","req","returning","select","where","whereArg","db","payload","collections","config","tableName","tableNameMap","get","slug","idToUpdate","selectFields","adapter","fields","flattenedFields","selectDistinctResult","query","limit","length","table","tables","docsToUpdate","from","result","ignoreResult","operation"],"mappings":"AAGA,OAAOA,iBAAiB,gBAAe;AAIvC,SAASC,UAAU,QAAQ,0BAAyB;AACpD,SAASC,cAAc,QAAQ,8BAA6B;AAC5D,SAASC,SAAS,QAAQ,uBAAsB;AAChD,SAASC,cAAc,QAAQ,gCAA+B;AAE9D,OAAO,MAAMC,YAAuB,eAAeA,UAEjD,EACEC,EAAE,EACFC,YAAYC,cAAc,EAC1BC,IAAI,EACJC,OAAOC,SAAS,EAChBC,MAAM,EACNC,GAAG,EACHC,SAAS,EACTC,MAAM,EACNC,OAAOC,QAAQ,EAChB;IAED,MAAMC,KAAK,MAAMd,eAAe,IAAI,EAAES;IACtC,MAAMN,aAAa,IAAI,CAACY,OAAO,CAACC,WAAW,CAACZ,eAAe,CAACa,MAAM;IAClE,MAAMC,YAAY,IAAI,CAACC,YAAY,CAACC,GAAG,CAACxB,YAAYO,WAAWkB,IAAI;IACnE,IAAIC,aAAapB;IAEjB,IAAI,CAACoB,YAAY;QACf,MAAM,EAAEhB,KAAK,EAAEiB,YAAY,EAAEX,KAAK,EAAE,GAAGf,WAAW;YAChD2B,SAAS,IAAI;YACbC,QAAQtB,WAAWuB,eAAe;YAClClB;YACAU;YACAN,OAAOC;QACT;QAEA,qDAAqD;QACrD,MAAMc,uBAAuB,MAAM7B,eAAe;YAChD0B,SAAS,IAAI;YACbV;YACAR;YACAsB,OAAO,CAAC,EAAEA,KAAK,EAAE,GAAKA,MAAMC,KAAK,CAAC;YAClCN;YACAL;YACAN;QACF;QAEA,IAAIe,sBAAsB,CAAC,EAAE,EAAEzB,IAAI;YACjCoB,aAAaK,sBAAsB,CAAC,EAAE,EAAEzB;QACxC,gFAAgF;QAClF,OAAO,IAAIW,YAAY,CAACP,MAAMwB,MAAM,EAAE;YACpC,MAAMC,QAAQ,IAAI,CAACC,MAAM,CAACd,UAAU;YAEpC,MAAMe,eAAe,MAAM,AAACnB,GACzBH,MAAM,CAAC;gBACNT,IAAI6B,MAAM7B,EAAE;YACd,GACCgC,IAAI,CAACH,OACLnB,KAAK,CAACA,OACNiB,KAAK,CAAC;YACTP,aAAaW,cAAc,CAAC,EAAE,EAAE/B;QAClC;IACF;IAEA,MAAMiC,SAAS,MAAMpC,UAAU;QAC7BG,IAAIoB;QACJE,SAAS,IAAI;QACbnB;QACAS;QACAW,QAAQtB,WAAWuB,eAAe;QAClCU,cAAc1B,cAAc;QAC5BH;QACA8B,WAAW;QACX5B;QACAE;QACAO;IACF;IAEA,IAAIR,cAAc,OAAO;QACvB,OAAO;IACT;IAEA,OAAOyB;AACT,EAAC"}