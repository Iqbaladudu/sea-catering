{"version":3,"sources":["../../../src/postgres/schema/buildDrizzleTable.ts"],"sourcesContent":["import type { ForeignKeyBuilder, IndexBuilder } from 'drizzle-orm/pg-core'\n\nimport {\n  boolean,\n  foreignKey,\n  index,\n  integer,\n  jsonb,\n  numeric,\n  serial,\n  text,\n  timestamp,\n  uniqueIndex,\n  uuid,\n  varchar,\n  vector,\n} from 'drizzle-orm/pg-core'\n\nimport type { RawColumn, RawTable } from '../../types.js'\nimport type { BasePostgresAdapter } from '../types.js'\n\nimport { geometryColumn } from './geometryColumn.js'\n\nconst rawColumnBuilderMap: Partial<Record<RawColumn['type'], any>> = {\n  boolean,\n  geometry: geometryColumn,\n  integer,\n  jsonb,\n  numeric,\n  serial,\n  text,\n  uuid,\n  varchar,\n}\n\nexport const buildDrizzleTable = ({\n  adapter,\n  rawTable,\n}: {\n  adapter: BasePostgresAdapter\n  rawTable: RawTable\n}) => {\n  const columns: Record<string, any> = {}\n\n  for (const [key, column] of Object.entries(rawTable.columns)) {\n    switch (column.type) {\n      case 'enum':\n        if ('locale' in column) {\n          columns[key] = adapter.enums.enum__locales(column.name)\n        } else {\n          adapter.enums[column.enumName] = adapter.pgSchema.enum(\n            column.enumName,\n            column.options as [string, ...string[]],\n          )\n          columns[key] = adapter.enums[column.enumName](column.name)\n        }\n        break\n\n      case 'timestamp': {\n        let builder = timestamp(column.name, {\n          mode: column.mode,\n          precision: column.precision,\n          withTimezone: column.withTimezone,\n        })\n\n        if (column.defaultNow) {\n          builder = builder.defaultNow()\n        }\n\n        columns[key] = builder\n        break\n      }\n\n      case 'uuid': {\n        let builder = uuid(column.name)\n\n        if (column.defaultRandom) {\n          builder = builder.defaultRandom()\n        }\n\n        columns[key] = builder\n        break\n      }\n\n      case 'vector': {\n        const builder = vector(column.name, { dimensions: column.dimensions })\n        columns[key] = builder\n\n        break\n      }\n\n      default:\n        columns[key] = rawColumnBuilderMap[column.type](column.name)\n        break\n    }\n\n    if (column.reference) {\n      columns[key].references(() => adapter.tables[column.reference.table][column.reference.name], {\n        onDelete: column.reference.onDelete,\n      })\n    }\n\n    if (column.primaryKey) {\n      columns[key].primaryKey()\n    }\n\n    if (column.notNull) {\n      columns[key].notNull()\n    }\n\n    if (typeof column.default !== 'undefined') {\n      let sanitizedDefault = column.default\n\n      if (column.type === 'geometry' && Array.isArray(column.default)) {\n        sanitizedDefault = `SRID=4326;POINT(${column.default[0]} ${column.default[1]})`\n      }\n\n      columns[key].default(sanitizedDefault)\n    }\n\n    if (column.type === 'geometry') {\n      if (!adapter.extensions.postgis) {\n        adapter.extensions.postgis = true\n      }\n    }\n  }\n\n  const extraConfig = (cols: any) => {\n    const config: Record<string, ForeignKeyBuilder | IndexBuilder> = {}\n\n    if (rawTable.indexes) {\n      for (const [key, rawIndex] of Object.entries(rawTable.indexes)) {\n        let fn: any = index\n        if (rawIndex.unique) {\n          fn = uniqueIndex\n        }\n\n        if (Array.isArray(rawIndex.on)) {\n          if (rawIndex.on.length) {\n            config[key] = fn(rawIndex.name).on(...rawIndex.on.map((colName) => cols[colName]))\n          }\n        } else {\n          config[key] = fn(rawIndex.name).on(cols[rawIndex.on])\n        }\n      }\n    }\n\n    if (rawTable.foreignKeys) {\n      for (const [key, rawForeignKey] of Object.entries(rawTable.foreignKeys)) {\n        let builder = foreignKey({\n          name: rawForeignKey.name,\n          columns: rawForeignKey.columns.map((colName) => cols[colName]) as any,\n          foreignColumns: rawForeignKey.foreignColumns.map(\n            (column) => adapter.tables[column.table][column.name],\n          ),\n        })\n\n        if (rawForeignKey.onDelete) {\n          builder = builder.onDelete(rawForeignKey.onDelete)\n        }\n\n        if (rawForeignKey.onUpdate) {\n          builder = builder.onDelete(rawForeignKey.onUpdate)\n        }\n\n        config[key] = builder\n      }\n    }\n\n    return config\n  }\n\n  adapter.tables[rawTable.name] = adapter.pgSchema.table(\n    rawTable.name,\n    columns as any,\n    extraConfig as any,\n  )\n}\n"],"names":["boolean","foreignKey","index","integer","jsonb","numeric","serial","text","timestamp","uniqueIndex","uuid","varchar","vector","geometryColumn","rawColumnBuilderMap","geometry","buildDrizzleTable","adapter","rawTable","columns","key","column","Object","entries","type","enums","enum__locales","name","enumName","pgSchema","enum","options","builder","mode","precision","withTimezone","defaultNow","defaultRandom","dimensions","reference","references","tables","table","onDelete","primaryKey","notNull","default","sanitizedDefault","Array","isArray","extensions","postgis","extraConfig","cols","config","indexes","rawIndex","fn","unique","on","length","map","colName","foreignKeys","rawForeignKey","foreignColumns","onUpdate"],"mappings":"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"}